"""æ–‡ä»¶ç»Ÿè®¡æ™ºèƒ½åŠ©æ‰‹ - åŸºäºQwen-Agent + MCPå®ç°

è¿™ä¸ªæ¨¡å—æä¾›äº†ä¸€ä¸ªæ™ºèƒ½æ–‡ä»¶ç»Ÿè®¡åŠ©æ‰‹ï¼Œå¯ä»¥é€šè¿‡è‡ªç„¶è¯­è¨€è¿›è¡Œæ–‡ä»¶åˆ†æå’Œç®¡ç†ï¼š
1. ç»Ÿè®¡ç›®å½•æ–‡ä»¶æ•°é‡å’Œå¤§å°
2. æŒ‰ç±»å‹åˆ†ç±»æ–‡ä»¶
3. æŸ¥æ‰¾å¤§æ–‡ä»¶å’Œé‡å¤æ–‡ä»¶
4. ç®¡ç†æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶
5. æ–‡ä»¶é‡å‘½åç­‰æ“ä½œ
"""

import os
import asyncio
from typing import Optional
import dashscope
from qwen_agent.agents import Assistant
from qwen_agent.gui import WebUI
from dotenv import load_dotenv

# åŠ è½½ç¯å¢ƒå˜é‡
load_dotenv()

# é…ç½® DashScope
dashscope.api_key = os.getenv('DASHSCOPE_API_KEY')
print(dashscope.api_key)
dashscope.timeout = 60  # å»¶é•¿è¶…æ—¶æ—¶é—´ä»¥å¤„ç†å¤§ç›®å½•

def init_file_stats_agent():
    """åˆå§‹åŒ–æ–‡ä»¶ç»Ÿè®¡æ™ºèƒ½åŠ©æ‰‹
    
    é…ç½®è¯´æ˜ï¼š
    - ä½¿ç”¨ qwen-max ä½œä¸ºåº•å±‚è¯­è¨€æ¨¡å‹
    - è®¾ç½®ç³»ç»Ÿè§’è‰²ä¸ºæ–‡ä»¶ç®¡ç†ä¸“å®¶
    - é›†æˆæ–‡ä»¶ç»Ÿè®¡MCPå·¥å…·
    
    Returns:
        Assistant: é…ç½®å¥½çš„æ–‡ä»¶ç»Ÿè®¡åŠ©æ‰‹å®ä¾‹
    """
    # LLM æ¨¡å‹é…ç½®
    llm_cfg = {
        'model': 'qwen-max',
        'timeout': 60,
        'retry_count': 3,
    }
    
    # ç³»ç»Ÿè§’è‰²è®¾å®š - æ–‡ä»¶ç®¡ç†ä¸“å®¶
    system = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡ä»¶ç®¡ç†åŠ©æ‰‹ï¼Œå…·å¤‡å¼ºå¤§çš„æ–‡ä»¶åˆ†æå’Œç»Ÿè®¡èƒ½åŠ›ã€‚

æ ¸å¿ƒèƒ½åŠ›ï¼š
1. æ–‡ä»¶ç»Ÿè®¡ï¼šç»Ÿè®¡ç›®å½•ä¸­çš„æ–‡ä»¶æ•°é‡ã€æ€»å¤§å°ã€å¹³å‡å¤§å°ç­‰
2. æ–‡ä»¶åˆ†ç±»ï¼šæŒ‰æ–‡ä»¶ç±»å‹ï¼ˆæ‰©å±•åï¼‰è‡ªåŠ¨åˆ†ç±»æ•´ç†
3. å¤§æ–‡ä»¶æ£€æµ‹ï¼šå¿«é€Ÿæ‰¾å‡ºå ç”¨ç©ºé—´æœ€å¤šçš„æ–‡ä»¶
4. é‡å¤æ–‡ä»¶æ¸…ç†ï¼šåŸºäºå†…å®¹å“ˆå¸Œå€¼æŸ¥æ‰¾é‡å¤æ–‡ä»¶
5. æ—¶é—´ç®¡ç†ï¼šåˆ†ææœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶ï¼Œæä¾›æ—¶é—´çº¿è§†å›¾
6. æ–‡ä»¶æ“ä½œï¼šæ”¯æŒæ–‡ä»¶é‡å‘½åç­‰åŸºç¡€æ“ä½œ

ä½¿ç”¨è§„èŒƒï¼š
- å§‹ç»ˆä½¿ç”¨ç»å¯¹è·¯å¾„å¤„ç†æ–‡ä»¶
- å¯¹äºå¤§ç›®å½•æ“ä½œï¼Œä¸»åŠ¨æé†’ç”¨æˆ·å¯èƒ½è€—æ—¶è¾ƒé•¿
- æä¾›æ¸…æ™°çš„ç»Ÿè®¡ç»“æœï¼ŒåŒ…æ‹¬æ•°å­—å’Œæ ¼å¼åŒ–å¤§å°
- å‘ç°å¼‚å¸¸ï¼ˆå¦‚å¤§æ–‡ä»¶ã€é‡å¤æ–‡ä»¶ï¼‰æ—¶ç»™å‡ºä¼˜åŒ–å»ºè®®
- æ”¯æŒé€’å½’å’Œéé€’å½’ä¸¤ç§æ¨¡å¼

äº¤äº’é£æ ¼ï¼š
- ç”¨ç®€æ´æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šå¤æ‚çš„æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
- ä¸»åŠ¨å‘ç°æ½œåœ¨é—®é¢˜å¹¶æä¾›è§£å†³æ–¹æ¡ˆ
- æ”¯æŒè‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œç†è§£ç”¨æˆ·çš„çœŸå®æ„å›¾

ç¤ºä¾‹å“åº”æ ¼å¼ï¼š
"ğŸ“Š ç›®å½•ç»Ÿè®¡ç»“æœï¼š
- æ€»æ–‡ä»¶æ•°ï¼š1,234ä¸ª
- æ€»å¤§å°ï¼š15.7 GB
- æœ€å¤§æ–‡ä»¶ï¼švideo.mp4 (2.3 GB)
- å»ºè®®ï¼šå‘ç°3ä¸ªé‡å¤æ–‡ä»¶ï¼Œå¯èŠ‚çœ500MBç©ºé—´"
"""

    # MCPå·¥å…·é…ç½® - è¿æ¥æ–‡ä»¶ç»Ÿè®¡æœåŠ¡å™¨
    tools = [{
        "type": "mcp",
        "mcpServers": {
            "file-stats": {
                "command": "python",
                "args": ["mcp_server.py"],
                "transport": "stdio"
            }
        }
    }]
    
    try:
        # åˆ›å»ºæ–‡ä»¶ç»Ÿè®¡åŠ©æ‰‹å®ä¾‹
        agent = Assistant(
            llm=llm_cfg,
            name='æ–‡ä»¶ç»Ÿè®¡æ™ºèƒ½åŠ©æ‰‹',
            description='æ™ºèƒ½æ–‡ä»¶åˆ†æä¸ç®¡ç†ä¸“å®¶',
            system_message=system,
            function_list=tools,
        )
        print("æ–‡ä»¶ç»Ÿè®¡æ™ºèƒ½åŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸï¼")
        return agent
    except Exception as e:
        print(f"æ–‡ä»¶ç»Ÿè®¡åŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {str(e)}")
        raise

def run_test_mode(query: str = "ç»Ÿè®¡å½“å‰ç›®å½•çš„æ–‡ä»¶æƒ…å†µ"):
    """æµ‹è¯•æ¨¡å¼ - å¿«é€ŸéªŒè¯åŠŸèƒ½
    
    Args:
        query: æµ‹è¯•æŸ¥è¯¢è¯­å¥
    """
    try:
        agent = init_file_stats_agent()
        messages = [{'role': 'user', 'content': query}]
        
        print("ğŸ§ª æµ‹è¯•æ¨¡å¼å¯åŠ¨...")
        print(f"æŸ¥è¯¢: {query}")
        print("-" * 50)
        
        for response in agent.run(messages):
            print('ğŸ¤– åŠ©æ‰‹å›å¤:', response)
            
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {str(e)}")

def run_tui_mode():
    """ç»ˆç«¯äº¤äº’æ¨¡å¼
    
    æä¾›å‘½ä»¤è¡Œäº¤äº’ç•Œé¢ï¼Œæ”¯æŒï¼š
    - è¿ç»­å¯¹è¯
    - æ™ºèƒ½æç¤º
    - å®æ—¶æ–‡ä»¶åˆ†æ
    """
    try:
        agent = init_file_stats_agent()
        messages = []
        
        print("ğŸš€ æ–‡ä»¶ç»Ÿè®¡æ™ºèƒ½åŠ©æ‰‹ - ç»ˆç«¯æ¨¡å¼")
        print("æ”¯æŒçš„æŸ¥è¯¢ç¤ºä¾‹ï¼š")
        print("â€¢ ç»Ÿè®¡æ¡Œé¢ç›®å½•çš„æ–‡ä»¶æƒ…å†µ")
        print("â€¢ æŒ‰ç±»å‹åˆ†ç±»æ˜¾ç¤ºæ–‡æ¡£ç›®å½•çš„æ–‡ä»¶")
        print("â€¢ æ‰¾å‡ºä¸‹è½½ç›®å½•è¶…è¿‡500MBçš„å¤§æ–‡ä»¶")
        print("â€¢ æ˜¾ç¤ºæœ€è¿‘7å¤©ä¿®æ”¹è¿‡çš„æ–‡ä»¶")
        print("â€¢ æ£€æŸ¥å›¾ç‰‡ç›®å½•æœ‰æ²¡æœ‰é‡å¤æ–‡ä»¶")
        print("â€¢ æŠŠtest.txté‡å‘½åä¸ºnew_test.txt")
        print("â€¢ é€€å‡º/quit - é€€å‡ºç¨‹åº")
        print("-" * 50)
        
        while True:
            try:
                query = input("\nğŸ‘¤ è¯·è¾“å…¥æŸ¥è¯¢: ").strip()
                
                if not query:
                    continue
                    
                if query.lower() in ['é€€å‡º', 'quit', 'exit']:
                    print("ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼")
                    break
                
                messages.append({'role': 'user', 'content': query})
                
                print("\nğŸ¤– æ­£åœ¨åˆ†æ...")
                for response in agent.run(messages):
                    print(f"å›å¤: {response}")
                    messages.extend(response)
                    
            except KeyboardInterrupt:
                print("\nğŸ‘‹ ç¨‹åºå·²ç»ˆæ­¢")
                break
            except Exception as e:
                print(f"âŒ å¤„ç†å‡ºé”™: {str(e)}")
                
    except Exception as e:
        print(f"âŒ å¯åŠ¨ç»ˆç«¯æ¨¡å¼å¤±è´¥: {str(e)}")

def run_gui_mode():
    """å›¾å½¢ç•Œé¢æ¨¡å¼ - Web GUI
    
    æä¾›ä¸“ä¸šçš„Webç•Œé¢ï¼Œç‰¹ç‚¹ï¼š
    - å‹å¥½çš„ç”¨æˆ·ç•Œé¢
    - æ™ºèƒ½æŸ¥è¯¢å»ºè®®
    - å®æ—¶æ–‡ä»¶åˆ†æç»“æœ
    - æ”¯æŒå†å²å¯¹è¯
    """
    try:
        agent = init_file_stats_agent()
        
        # æ™ºèƒ½æŸ¥è¯¢å»ºè®®é…ç½®
        chatbot_config = {
            'prompt.suggestions': [
                'ç»Ÿè®¡å½“å‰ç›®å½•çš„æ–‡ä»¶æ€»æ•°å’Œæ€»å¤§å°',
                'æŒ‰æ‰©å±•ååˆ†ç±»æ˜¾ç¤ºæ¡Œé¢ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶',
                'æ‰¾å‡ºä¸‹è½½ç›®å½•ä¸­è¶…è¿‡100MBçš„å¤§æ–‡ä»¶',
                'æ˜¾ç¤ºæœ€è¿‘7å¤©å†…ä¿®æ”¹è¿‡çš„æ‰€æœ‰æ–‡ä»¶',
                'æ£€æŸ¥æ–‡æ¡£ç›®å½•æ˜¯å¦æœ‰é‡å¤æ–‡ä»¶',
                'æ¸…ç†æ¡Œé¢ç›®å½•çš„ç©ºæ–‡ä»¶å¤¹',
                'æ˜¾ç¤ºæœ€è¿‘30å¤©çš„æ–‡ä»¶æ—¶é—´çº¿',
                'ç»Ÿè®¡2024-01-01åˆ°2024-12-31åˆ›å»ºçš„æ–‡ä»¶',
                'é‡å‘½åæ–‡ä»¶ old_name.txt ä¸º new_name.txt',
                'åˆ†æç”¨æˆ·ç›®å½•çš„ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ',
                'æŒ‰å‘¨ç»Ÿè®¡æœ€è¿‘ä¸€ä¸ªæœˆçš„æ–‡ä»¶åˆ›å»ºæƒ…å†µ',
                'æŸ¥æ‰¾å¹¶åˆ—å‡ºæ‰€æœ‰å›¾ç‰‡æ–‡ä»¶ï¼ˆjpg, png, gifï¼‰',
                'ç»Ÿè®¡ä»£ç ç›®å½•ä¸­ä¸åŒç¼–ç¨‹è¯­è¨€çš„æ–‡ä»¶æ•°é‡',
                'åˆ†æå¤§æ–‡ä»¶å¹¶æä¾›æ¸…ç†å»ºè®®',
                'åˆ›å»ºæœ€è¿‘ä¿®æ”¹æ–‡ä»¶çš„è¯¦ç»†æŠ¥å‘Š'
            ]
        }
        
        print("ğŸŒ å¯åŠ¨æ–‡ä»¶ç»Ÿè®¡æ™ºèƒ½åŠ©æ‰‹ Webç•Œé¢...")
        print("è®¿é—®åœ°å€: http://localhost:8001")
        
        WebUI(
            agent,
            chatbot_config=chatbot_config
        ).run(port=8001)
        
    except Exception as e:
        print(f"âŒ å¯åŠ¨Webç•Œé¢å¤±è´¥: {str(e)}")
        print("è¯·æ£€æŸ¥ï¼š")
        print("1. DashScope API Keyæ˜¯å¦é…ç½®æ­£ç¡®")
        print("2. ç«¯å£8001æ˜¯å¦è¢«å ç”¨")
        print("3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")

if __name__ == '__main__':
    # è¿è¡Œæ¨¡å¼é€‰æ‹©
    import sys
    
    if len(sys.argv) > 1:
        mode = sys.argv[1].lower()
        if mode == 'test':
            run_test_mode()
        elif mode == 'tui':
            run_tui_mode()
        elif mode == 'gui':
            run_gui_mode()
        else:
            print("ä½¿ç”¨æ–¹å¼:")
            print("python file_stats_agent.py test  # æµ‹è¯•æ¨¡å¼")
            print("python file_stats_agent.py tui   # ç»ˆç«¯æ¨¡å¼")
            print("python file_stats_agent.py gui   # Webç•Œé¢æ¨¡å¼")
            print("python file_stats_agent.py       # é»˜è®¤Webç•Œé¢æ¨¡å¼")
    else:
        # é»˜è®¤å¯åŠ¨Webç•Œé¢
        run_gui_mode()